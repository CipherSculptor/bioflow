document.addEventListener('DOMContentLoaded', () => {
    const profileButton = document.getElementById('profileButton');
    const profileDropdown = document.getElementById('profileDropdown');
    
    // Toggle profile dropdown
    profileButton.addEventListener('click', (e) => {
        e.stopPropagation();
        profileDropdown.classList.toggle('show');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!profileButton.contains(e.target)) {
            profileDropdown.classList.remove('show');
        }
    });

    try {
        // Load user details and results
        const userData = JSON.parse(localStorage.getItem('userDetails') || '{}');
        console.log('User data from localStorage:', userData);
        
        // Check if we have prediction results
        if (!userData.results) {
            console.error('No results found in localStorage');
            alert('No results found. Redirecting to dashboard.');
            window.location.href = 'dashboard.html';
            return;
        }

        // Display results in the form
        document.getElementById('resultName').value = userData.results.name || '-';
        document.getElementById('resultBloodGroup').value = userData.results.blood_group || '-';
        document.getElementById('resultHemoglobin').value = userData.results.hemoglobin || '-';
        document.getElementById('resultRBCCount').value = userData.results.rbc_count || '-';
        document.getElementById('resultPlateletsCount').value = userData.results.platelets_count || '-';
        
        console.log('Results displayed successfully');
    } catch (error) {
        console.error('Error loading results:', error);
        alert('Error loading results: ' + error.message);
    }
});

// Function to generate and download PDF
function generatePDF() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add header
        doc.setFontSize(22);
        doc.setTextColor(120, 3, 3);
        doc.text('BioFlow - Blood Test Results', 105, 20, { align: 'center' });
        
        // Add date
        doc.setFontSize(12);
        doc.setTextColor(100, 100, 100);
        const today = new Date();
        doc.text(`Date: ${today.toLocaleDateString()}`, 105, 30, { align: 'center' });
        
        // Add content
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        
        const name = document.getElementById('resultName').value;
        const bloodGroup = document.getElementById('resultBloodGroup').value;
        const hemoglobin = document.getElementById('resultHemoglobin').value;
        const rbcCount = document.getElementById('resultRBCCount').value;
        const plateletsCount = document.getElementById('resultPlateletsCount').value;
        
        doc.text(`Name: ${name}`, 20, 50);
        doc.text(`Blood Group: ${bloodGroup}`, 20, 70);
        doc.text(`Hemoglobin: ${hemoglobin}`, 20, 90);
        doc.text(`RBC Count: ${rbcCount}`, 20, 110);
        doc.text(`Platelets Count: ${plateletsCount}`, 20, 130);
        
        // Add footer
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text('This report is generated by BioFlow. Results are based on machine learning predictions.', 105, 250, { align: 'center' });
        
        // Save the PDF
        doc.save(`BioFlow_Report_${name.replace(/\s+/g, '_')}.pdf`);
        
        console.log('PDF generated successfully');
    } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Error generating PDF: ' + error.message);
    }
} 